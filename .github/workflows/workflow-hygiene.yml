name: workflow-hygiene

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: workflow-hygiene-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow-gates:
    name: Workflow Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: '3.13.8'

      - name: Install workflow verification tools
        shell: bash
        run: |
          set -euo pipefail
          python -m pip --version
          python -m pip install pyyaml==6.0.3 actionlint-py==1.7.7.25
          actionlint --version

      - name: Verify action pinning
        shell: bash
        run: |
          set -euo pipefail
          python tools/verify_action_pinning.py --workflows .github/workflows

      - name: Verify workflow hygiene
        shell: bash
        run: |
          set -euo pipefail
          python engine/tools/verify_workflow_hygiene.py --workflows .github/workflows

      - name: Actionlint
        shell: bash
        run: |
          set -euo pipefail
          actionlint .github/workflows/*.yml
