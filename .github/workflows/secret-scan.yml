name: Secret Scan (Gitleaks)

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'build_proof/**'
      - '**/*.md'
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: secret-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: gitleaks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    env:
      GITLEAKS_ENABLE_PR_COMMENTS: 'false'
      GITLEAKS_ENABLE_SARIF_UPLOAD: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@b0f320ce5e5370a97f4cde6f0f08f442a5f2e0d1 # v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: ${{ env.GITLEAKS_ENABLE_PR_COMMENTS }}

      - name: Upload SARIF
        if: always() && env.GITLEAKS_ENABLE_SARIF_UPLOAD == 'true'
        uses: github/codeql-action/upload-sarif@2f4f4f97d1e8d0f6c14a2fdbef674e7dc86d51a3 # v4.22.5
        with:
          sarif_file: results.sarif

      - name: Upload raw scan artifact
        if: always()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.6.0
        with:
          name: gitleaks-${{ github.run_id }}
          retention-days: 30
          path: |
            results.sarif
            gitleaks-report.json
