name: ci-dispatch

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to evaluate and dispatch"
        required: true
        type: string
      dry_run:
        description: "Compute required workflows but do not dispatch"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: read
  pull-requests: read
  actions: write
  checks: read

concurrency:
  group: ci-dispatch-${{ inputs.pr_number }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.13.8"
  PIP_VERSION: "26.0"

jobs:
  dispatch-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONHASHSEED: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up Python + pinned pip
        uses: ./.github/actions/setup-python-pip
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          pip-version: ${{ env.PIP_VERSION }}

      - name: Configure Python bytecode cache path
        run: |
          set -euo pipefail
          echo "PYTHONPYCACHEPREFIX=${RUNNER_TEMP}/pycache" >> "$GITHUB_ENV"
          mkdir -p "${RUNNER_TEMP}/pycache"

      - name: Capture runtime env
        run: |
          set -euo pipefail
          mkdir -p "${RUNNER_TEMP}/ci_dispatch" "${PYTHONPYCACHEPREFIX}"
          {
            python --version
            python -m pip --version
            git rev-parse HEAD
          } | tee "${RUNNER_TEMP}/ci_dispatch/env.txt"

      - name: Assert pinned pip version
        run: |
          set -euo pipefail
          actual="$(python -m pip --version | awk '{print $2}')"
          expected="${PIP_VERSION}"
          if [[ "${actual}" != "${expected}" ]]; then
            echo "::error::pip version mismatch (expected=${expected}, actual=${actual})"
            exit 1
          fi

      - name: Run PR CI dispatcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          DRY_RUN: ${{ inputs.dry_run }}
          DISPATCH_TIMEOUT_SECONDS: "2700"
          DISPATCH_POLL_INTERVAL_SECONDS: "20"
        run: |
          set -euo pipefail
          mkdir -p "${RUNNER_TEMP}/ci_dispatch"
          python tools/ci/dispatch_ci_for_pr.py \
            --pr "$PR_NUMBER" \
            --dry-run "$DRY_RUN" \
            --timeout-seconds "$DISPATCH_TIMEOUT_SECONDS" \
            --poll-interval-seconds "$DISPATCH_POLL_INTERVAL_SECONDS" \
            --out-dir "${RUNNER_TEMP}/ci_dispatch"

      - name: Check workspace drift
        run: |
          set -euo pipefail
          git status --porcelain | tee "${RUNNER_TEMP}/ci_dispatch/drift-status.txt"
          git diff --name-only | tee "${RUNNER_TEMP}/ci_dispatch/drift-diff.txt"
          if [[ -s "${RUNNER_TEMP}/ci_dispatch/drift-status.txt" || -s "${RUNNER_TEMP}/ci_dispatch/drift-diff.txt" ]]; then
            echo "::error::workspace drift detected"
            exit 1
          fi

      - name: Upload CI dispatch evidence
        if: always()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: ci-dispatch-${{ github.run_id }}
          retention-days: 30
          if-no-files-found: error
          path: ${{ runner.temp }}/ci_dispatch/**
