{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "axl://schemas/pb/v2.1",
  "title": "ProofBundle",
  "description": "PB mandatory schema — PRODUCTION_SPEC_V2.1 G2-EVIDENCE gate. Any missing field → FAIL_CLOSED.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "pb_id",
    "timestamp",
    "environment_class",
    "ac_version_sha256",
    "prev_pb_hash",
    "input_state_hash",
    "output_state_hash",
    "gate_results",
    "metrics",
    "actions",
    "evidence_anchors",
    "signature"
  ],
  "properties": {
    "pb_id": {
      "type": "string",
      "pattern": "^PB-[A-F0-9]{16,}$",
      "description": "Unique PB identifier (uppercase hex, 16+ chars)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "environment_class": {
      "type": "string",
      "enum": ["restricted_sandbox", "tee_enabled"],
      "description": "Must match AC.env_class — NO_TEE rejected at validation"
    },
    "ac_version_sha256": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Must match AC.ac_version_sha256 exactly (identity binding)"
    },
    "prev_pb_hash": {
      "type": ["string", "null"],
      "description": "SHA-256 of previous PB (null only for genesis bundle); immutable hash chain"
    },
    "input_state_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    },
    "output_state_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    },
    "ads_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "ADS artifact hash — required when actions[] is non-empty"
    },
    "gate_results": {
      "type": "object",
      "additionalProperties": false,
      "required": ["G0", "G1", "G2", "G3", "G4", "G5", "G6", "G7", "G11"],
      "properties": {
        "G0":  { "$ref": "#/$defs/GateResult" },
        "G1":  { "$ref": "#/$defs/GateResult" },
        "G2":  { "$ref": "#/$defs/GateResult" },
        "G3":  { "$ref": "#/$defs/GateResult" },
        "G4":  { "$ref": "#/$defs/GateResult" },
        "G5":  { "$ref": "#/$defs/GateResult" },
        "G6":  { "$ref": "#/$defs/GateResult" },
        "G7":  { "$ref": "#/$defs/GateResult" },
        "G11": { "$ref": "#/$defs/GateResult" }
      }
    },
    "metrics": {
      "type": "object",
      "required": [
        "P_p", "A_s", "ReproRate",
        "replay_n", "replay_mismatches",
        "FVR", "CT", "PB_Completeness",
        "SSDF_coverage", "SSDF_regressions",
        "CFR"
      ],
      "additionalProperties": true,
      "properties": {
        "P_p":                { "type": "number", "description": "Action precision rate" },
        "A_s":                { "type": "number", "description": "Agent success rate" },
        "L_rtt":              { "type": "number", "description": "Latency RTT ms" },
        "D_cs":               { "type": "number", "description": "Determinism consistency score" },
        "ReproRate":          { "type": "number", "minimum": 0, "maximum": 1.0,
                                "description": "Build reproducibility rate (1.0 required)" },
        "replay_n":           { "type": "integer", "minimum": 0 },
        "replay_mismatches":  { "type": "integer", "minimum": 0,
                                "description": "Must be 0 for G4 PASS" },
        "FVR":                { "type": "number", "minimum": 0, "maximum": 1.0,
                                "description": "Formal Verification Rate — 1.0 required for G7" },
        "CT":                 { "type": "number", "minimum": 0, "maximum": 1.0,
                                "description": "Chain Trust — 1.0 = 100% bundles verified" },
        "PB_Completeness":    { "type": "number", "minimum": 0, "maximum": 1.0,
                                "description": "1.0 required — missing fields → FAIL" },
        "SSDF_coverage":      { "type": "number", "minimum": 0, "maximum": 1.0 },
        "SSDF_regressions":   { "type": "integer", "minimum": 0,
                                "description": "0 required for G3 PASS" },
        "CFR":                { "type": "number", "minimum": 0, "maximum": 1.0,
                                "description": "Change Failure Rate — 0.0 required for CI-L10" },
        "E_n":                { "type": "number", "description": "Expected errors per run" },
        "DeterminismHashStability": { "type": "number" }
      }
    },
    "actions": {
      "type": "array",
      "items": { "$ref": "#/$defs/ActionRecord" },
      "description": "Ordered list of actions in this bundle"
    },
    "evidence_anchors": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "pattern": "^§REF:[A-Za-z0-9_-]+#[A-Za-z0-9_./:-]+#[a-f0-9]{64}$"
      },
      "description": "§REF:<domain>#<artifact_id>#<sha256> — non-empty set required"
    },
    "signature": {
      "type": "object",
      "required": ["jws", "alg", "kid", "signed_at"],
      "additionalProperties": false,
      "properties": {
        "jws":      { "type": "string", "minLength": 16 },
        "alg":      { "type": "string", "enum": ["ES256", "ES384", "PS256", "EdDSA"] },
        "kid":      { "type": "string" },
        "signed_at":{ "type": "string", "format": "date-time" }
      }
    }
  },
  "$defs": {
    "GateResult": {
      "type": "object",
      "required": ["status", "checked_at"],
      "additionalProperties": false,
      "properties": {
        "status":     { "type": "string", "enum": ["PASS", "FAIL", "SKIP", "UNKNOWN"] },
        "checked_at": { "type": "string", "format": "date-time" },
        "detail":     { "type": "string" },
        "blocker":    { "type": "string", "description": "File:line ref on FAIL — required if status=FAIL" }
      }
    },
    "ActionRecord": {
      "type": "object",
      "required": ["action_id", "type", "pre_hash", "post_hash", "rollback_ref", "executed_at"],
      "additionalProperties": true,
      "properties": {
        "action_id":    { "type": "string" },
        "type":         { "type": "string" },
        "pre_hash":     { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "post_hash":    { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "rollback_ref": { "type": "string", "description": "Runbook section or artifact ref for rollback" },
        "executed_at":  { "type": "string", "format": "date-time" }
      }
    }
  }
}
