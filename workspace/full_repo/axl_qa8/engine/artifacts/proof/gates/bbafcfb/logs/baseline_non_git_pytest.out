...................................F...F.....F...............            [100%]
=================================== FAILURES ===================================
_____________________ test_no_generated_artifacts_tracked ______________________

    def test_no_generated_artifacts_tracked() -> None:
        p = run(["git", "ls-files"])
>       assert p.returncode == 0, p.stderr
E       AssertionError: fatal: not a git repository (or any of the parent directories): .git
E         
E       assert 128 == 0
E        +  where 128 = CompletedProcess(args=['git', 'ls-files'], returncode=128, stdout='', stderr='fatal: not a git repository (or any of the parent directories): .git\n').returncode

tests/test_repo_invariants.py:31: AssertionError
__________________ test_sg_vr_accepts_config_after_subcommand __________________

    def test_sg_vr_accepts_config_after_subcommand() -> None:
        p = run(
            [
                "python",
                "-m",
                "exoneural_governor.cli",
                "vr",
                "--config",
                "configs/sg.config.json",
                "--out",
                "VR.json",
                "--no-write",
            ]
        )
>       assert p.returncode in (0, 3), p.stdout + "\n" + p.stderr
E       AssertionError: 
E         Traceback (most recent call last):
E           File "/root/.pyenv/versions/3.10.19/lib/python3.10/runpy.py", line 196, in _run_module_as_main
E             return _run_code(code, main_globals, None,
E           File "/root/.pyenv/versions/3.10.19/lib/python3.10/runpy.py", line 86, in _run_code
E             exec(code, run_globals)
E           File "/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/cli.py", line 145, in <module>
E             main()
E           File "/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/cli.py", line 129, in main
E             rc = cmd_vr(cfg_path, out_path=Path(args.out), write_back=(not args.no_write))
E           File "/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/cli.py", line 59, in cmd_vr
E             vr = run_vr(cfg, write_back=False)
E           File "/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/vr.py", line 92, in run_vr
E             work_id = _work_id(repo_root, cfg)
E           File "/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/vr.py", line 68, in _work_id
E             raise ValueError(
E         ValueError: E_NO_GIT_NO_BUILD_ID: git commit unavailable; set BUILD_ID for deterministic provenance id.
E         
E       assert 1 in (0, 3)
E        +  where 1 = CompletedProcess(args=['python', '-m', 'exoneural_governor.cli', 'vr', '--config', 'configs/sg.config.json', '--out', ...alueError(\nValueError: E_NO_GIT_NO_BUILD_ID: git commit unavailable; set BUILD_ID for deterministic provenance id.\n').returncode

tests/test_repo_invariants.py:92: AssertionError
_____________________________ test_vr_and_release ______________________________

tmp_path = PosixPath('/tmp/pytest-of-root/pytest-6/test_vr_and_release0')

    def test_vr_and_release(tmp_path):
        repo_root = Path(__file__).resolve().parents[1]
        cfg = load_config(repo_root / "configs" / "sg.config.json")
>       vr = run_vr(cfg, write_back=False)

/tmp/tmp.u91rFCFyZ5/repo/tests/test_stack.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/vr.py:92: in run_vr
    work_id = _work_id(repo_root, cfg)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

repo_root = PosixPath('/tmp/tmp.u91rFCFyZ5/repo')
cfg = Config(repo_root=PosixPath('/tmp/tmp.u91rFCFyZ5/repo'), base_branch='main', allowlist_globs=['README.md', 'MANIFEST.js....u91rFCFyZ5/repo/SECURITY.redaction.yml'), evidence_root_base=PosixPath('/tmp/tmp.u91rFCFyZ5/repo/artifacts/evidence'))

    def _work_id(repo_root: Path, cfg: Config) -> str:
        # Prefer git HEAD when available; otherwise require BUILD_ID and derive a stable fingerprint.
        tmp_dir = repo_root / "artifacts" / "tmp"
        ensure_dir(tmp_dir)
        head = run_cmd(
            ["git", "rev-parse", "HEAD"],
            cwd=repo_root,
            stdout_path=tmp_dir / "head.stdout",
            stderr_path=tmp_dir / "head.stderr",
        )
        if head.exit_code == 0:
            git_commit = (
                (tmp_dir / "head.stdout")
                .read_text(encoding="utf-8", errors="replace")
                .strip()
            )
            if git_commit:
                return git_commit
    
        build_id = os.environ.get("BUILD_ID", "").strip()
        if not build_id:
>           raise ValueError(
                "E_NO_GIT_NO_BUILD_ID: git commit unavailable; set BUILD_ID for deterministic provenance id."
            )
E           ValueError: E_NO_GIT_NO_BUILD_ID: git commit unavailable; set BUILD_ID for deterministic provenance id.

/tmp/tmp.u91rFCFyZ5/repo/exoneural_governor/vr.py:68: ValueError
=========================== short test summary info ============================
FAILED ../../tmp/tmp.u91rFCFyZ5/repo/tests/test_repo_invariants.py::test_no_generated_artifacts_tracked
FAILED ../../tmp/tmp.u91rFCFyZ5/repo/tests/test_repo_invariants.py::test_sg_vr_accepts_config_after_subcommand
FAILED ../../tmp/tmp.u91rFCFyZ5/repo/tests/test_stack.py::test_vr_and_release
3 failed, 58 passed in 93.71s (0:01:33)
