scpe_release: v1.0
schema_version: ERM-2026.3
purpose: "deterministic emergency redesign mode: deadlock -> validated self-patch -> meta-PR or hard_revert_ssot"
entry_policy:
  trigger:
    consecutive_fails_min: 3
    required_deficit_severity: "S0"
    deadlock_fingerprint_stability: "same_for_last_3"
  forbidden_if:
    - "missing(REPORTS/meta-state.json)"
    - "missing(SECURITY.redaction.yml)"
  budgets:
    wallclock_seconds_max: 300
    iterations_max: 1
isolation:
  shadow_worktree_root: ".scpe-shadow"
  shadow_branch_prefix: "meta/erm"
  primary_worktree_immutable: true
ssot_patch_allowlist:
  - "PA.txt"
  - "IM.yml"
  - "QM.yml"
  - "GM.yml"
  - "CG.json"
  - "OH.yml"
  - "ERM.yml"
  - "PL.json"
  - "tools/validate_erm_ast.py"
  - "tools/prove_meta_validity.py"
  - "tools/make_manifest_meta.py"
  - "tools/deadlock_fingerprint.py"
  - "tools/observe_meta_state.py"
  - "tools/select_erm_txn.py"
  - "tools/apply_erm_txn.py"
allowlist_escalation:
  rule: "only SSOT allowlist may be extended, and only to include ssot_patch_allowlist paths"
  forbidden_ops:
    - "add arbitrary runtime code execution surfaces"
    - "weaken UNKNOWN->FAIL"
    - "weaken minimal diff budgets"
    - "add bypass for tests or security gates"
transaction_schema:
  required_fields:
    - "txn_id"
    - "base_ssot"
    - "deadlock_fingerprint"
    - "ops"
    - "patches"
    - "expected_outputs"
  base_ssot:
    required_fields: ["git_sha", "ssot_sha256_map"]
  ops_item:
    required_fields: ["op_id", "type", "target_path", "preconditions", "postconditions"]
  patches_item:
    required_fields: ["path", "unified_diff_sha256", "unified_diff"]
  expected_outputs:
    required_fields: ["ssot_sha256_map_after", "meta_gates_expected"]
contradiction_model:
  definition: "any new or modified IM rule that introduces overlapping-action conflict without strict priority resolution"
  check_rules:
    - "all interpreted_rules ids unique"
    - "all priorities are integers"
    - "tie_break remains unchanged"
    - "any equal priority rules with overlapping recommended_actions -> FAIL"
  record_path: "REPORTS/meta-contradictions.json"
recipes:
  - recipe_id: "ERM.RCP.000"
    selector:
      type: "exact_deadlock_fingerprint"
      value: "NO_MATCH"
    action: "hard_revert_ssot"
    reason: "no deterministic recipe match; entropy forbidden"
  - recipe_id: "ERM.RCP.010"
    selector:
      type: "exact_deadlock_fingerprint"
      value: "DFP:missing_reports"
    txn_template:
      txn_id: "ERM.TXN.010"
      ops:
        - op_id: "OP.010"
          type: "patch_file"
          target_path: "IM.yml"
          preconditions:
            - "deadlock.category==instrumentation"
            - "deadlock.missing_reports_count>0"
          postconditions:
            - "IM.yml schema_version bumped"
      patches:
        - path: "IM.yml"
          unified_diff_sha256: "TBD_BY_TOOL"
          unified_diff: |
            @@
            -schema_version: IM-2026.2
            +schema_version: IM-2026.3
            @@
            +  - id: "M.META"
            +    required_reports: ["REPORTS/meta-state.json","REPORTS/deadlock.json"]
    constraint: "patch must only append modality M.META and bump schema_version"
meta_gates:
  - id: "G.META.001"
    meaning: "ERM transaction is AST-valid and deterministic."
  - id: "G.META.002"
    meaning: "Fail-closed invariants preserved and no regression introduced by SSOT patch."
  - id: "G.META.003"
    meaning: "Shadow isolation holds and primary worktree unchanged prior to meta gates PASS."
