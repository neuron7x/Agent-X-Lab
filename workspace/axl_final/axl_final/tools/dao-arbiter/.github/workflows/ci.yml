name: DAO-LIFEBOOK CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  verify:
    name: Verify repo integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run repo verification
        run: python scripts/verify_repo.py

  test:
    name: Python SDK tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest dao_lifebook/tests.py -v --tb=short

  schema-lint:
    name: Validate JSON schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          python -c "
          import json, glob, sys
          errors = []
          for f in glob.glob('**/*.json', recursive=True):
              try:
                  json.load(open(f))
              except Exception as e:
                  errors.append(f'{f}: {e}')
          if errors:
              print('JSON errors:')
              for e in errors: print(f'  {e}')
              sys.exit(1)
          print(f'All JSON files valid')
          "
